var Utils=function(){var e={};return e.convertToHeading=function(e){var n=e%360;return 0>n?n+360:n},e.convertToNumber=function(e){return e>180?e-360:e},e.headingDifference=function(e,n){var t=Math.abs(e-n)%360;return t>180&&(t=360-t),t},e}(),Viewport=function(e){function n(n){r+=n;var t=Math.abs(r%i.length);createjs.Tween.get(e,{override:!0}).to({scaleX:i[t],scaleY:i[t]},1e3,createjs.Ease.sineOut)}var t=400,a=300,r=1,i=[.25,.5,1],o=new createjs.Container;return o.name="viewport",e.x=t/2,e.y=a/2,o.addChild(e),o.__defineGetter__("width",function(){return t}),o.__defineSetter__("width",function(e){return o.canvasSizeChanged(e,a),t}),o.__defineGetter__("height",function(){return a}),o.__defineSetter__("height",function(e){return o.canvasSizeChanged(t,e),a}),o.canvasSizeChanged=function(n,r){console.log("canvasSizeChanged",n,r),t=n,a=r,e.x=n/2,e.y=r/2},o.zoomIn=function(){n(1)},o.zoomOut=function(){n(-1)},o},World=function(){function e(){var e=i.getHeading(),t=i.getSpeed();document.getElementById("heading").innerHTML="Heading: "+Math.round(e),document.getElementById("knots").innerHTML="Knots: "+Math.round(t);var o=.3*t,c=Math.sin(e*Math.PI/180)*o,s=Math.cos(e*Math.PI/180)*o,d=Math.round(60*c),u=Math.round(60*s);createjs.Tween.get(a,{override:!0}).to({x:-d,y:u},1e3,createjs.Ease.sineOut),createjs.Tween.get(r,{override:!0}).to({x:-d,y:u},1e3,createjs.Ease.sineOut),a.regX+=c,a.regY-=s,i.x+=c,i.y-=s,r.position.x-=c,r.position.y+=s,n+=Math.round(t),n>=7&&(n=0,r.spawnBubble()),i.update(),r.update()}var n=0,t=new createjs.Container;t.name="world";var a=t.map=new createjs.Container,r=t.ocean=new Ocean(500,500);t.weather=new Weather;var i=t.playerBoat=new PlayerBoat,o=new createjs.Bitmap("images/island.png");o.y=-2e3;var c=new createjs.Shape;return c.graphics.beginFill("#F00"),c.graphics.drawCircle(-5,-5,20),c.graphics.endFill(),a.addChild(c,o,i),t.addChild(r,a),createjs.Ticker.addEventListener("tick",e),t},Gauge=function(){var e=new createjs.Container;e.width=e.height=100;var n=new createjs.Bitmap("images/windgauge.png"),t=new createjs.Bitmap("images/compass.png"),a=new createjs.Bitmap("images/needle.png");return n.regX=t.regX=a.regX=e.width/2,n.regY=t.regY=a.regY=e.height/2,e.addChild(n,t,a),e.update=function(){n.rotation=Game.world.weather.wind.direction,a.rotation=Game.world.playerBoat.getHeading()},e},Ocean=function(e,n){function t(){i.x=a.position.x%200,i.y=a.position.y%150}var a=new createjs.Container;a.width=e,a.height=n,a.position={x:0,y:0};var r=3*e+3*n,i=new createjs.Shape,o=i.graphics;o.beginBitmapFill(Game.assets.waves),o.drawRect(-r,-r,2*r,2*r);var c=new createjs.Container;return a.addChild(c,i),a.spawnBubble=function(){var e=new Bubble;e.x=-a.position.x,e.y=-a.position.y,e.animate(),c.addChild(e)},a.update=function(){document.getElementById("coords").innerHTML="x:"+a.position.x+" - y:"+a.position.y,c.x=a.position.x,c.y=a.position.y,t()},a},Bubble=function(){function e(){a.parent.removeChild(a)}function n(e,n){return Math.random()*(n-e)+e}var t=100,a=new createjs.Shape;return a.graphics.beginFill("#95cbdc"),a.graphics.drawCircle(-5,-5,10),a.graphics.endFill(),a.scaleX=a.scaleY=.1,a.animate=function(){var r=n(-t,t)+a.x,i=n(-t,t)+a.y,o=n(1,3);createjs.Tween.get(a,{loop:!1}).set({scaleX:.1,scaleY:.1},a).to({x:r,y:i,scaleX:o,scaleY:o,alpha:0},3e3,createjs.Ease.easeOut).call(e)},a},Weather=function(){var e={wind:{speed:10,direction:45}};return e},Boat=function(){function e(){var e=0;l.sails.map(function(n){e+=n.power}),e=e/l.sails.length*o,s!=e&&(s>e&&(s-=.01),e>s&&(s+=.05))}function n(){var e=Utils.convertToHeading(Game.world.weather.wind.direction-l.rotation);f.trim(e),w.trim(e)}function t(){f.reef(),w.reef()}function a(){f.hoist(),w.hoist(),n()}var r=56,i=125,o=10,c=1,s=0,d=!0,u=0,l=new createjs.Container;l.regX=r/2,l.regY=i/2;var g=new createjs.Bitmap("images/small_boat.png"),h=new Helm,f=new SquareRig(1.5*r,{x:10,y:i/2+20},{x:r-10,y:i/2+20}),w=new ForeAft(.5*i,{x:r/2,y:i-20});return f.x=r/2,w.x=r/2,f.y=45,w.y=55,l.sails=[f,w],l.addChild(g,f,w),l.turnLeft=h.turnLeft,l.turnRight=h.turnRight,l.stopTurning=function(){h.stopTurning(),l.rotation=Math.round(l.rotation)},l.toggleSails=function(){d?a():t(),d=!d},l.getSpeed=function(){return s},l.getWidth=function(){return r},l.getLength=function(){return i},l.getHeading=function(){var e=l.rotation%360;return 0>e?e+360:e},l.getSternPosition=function(){return i-l.regY},l.update=function(){e();var t=h.turnAmount*c,a=u-Game.world.weather.wind.direction;if(0!==t||0!==a){if(u=Game.world.weather.wind.direction,0!==t){var r=(l.rotation+t)%360;l.rotation=0>r?r+360:r}d||n()}},l},PlayerBoat=function(){var e=new Boat;return Game.addEventListener("onKeyDown",function(n){switch(n.key){case 37:e.turnLeft();break;case 39:e.turnRight()}}),Game.addEventListener("onKeyUp",function(n){switch(n.key){case 83:e.toggleSails();break;case 37:case 39:e.stopTurning()}}),e},Sail=function(e,n,t){function a(){var e=Utils.convertToHeading(s.angle),n=Utils.headingDifference(c,e);"fore-aft"==s.name;var a=10;if(n>t+a)i=0;else{var o=Math.abs(r-n),d=(t-o)/t;i=d}s.drawSail&&s.drawSail()}var r=180-e,i=0,o=!0,c=0,s=new createjs.Container;return s.hoist=function(){o=!1},s.reef=function(){o=!0,s.angle=0},s.trim=function(e){c=e;var n=Math.abs(Utils.convertToNumber(e))>t;if(n)s.angle=0;else{var a=e>180?r:-r;s.angle=Utils.convertToNumber(e+a)}},s.__defineSetter__("angle",function(e){var t=e;-n>e?t=-n:e>n&&(t=n),createjs.Tween.get(s,{override:!0}).to({rotation:t},2e3,createjs.Ease.linear).addEventListener("change",a)}),s.__defineGetter__("angle",function(){return s.rotation}),s.__defineGetter__("power",function(){return o?0:i}),s.__defineGetter__("tack",function(){return c>180?"port":"starboard"}),s},SquareRig=function(e,n,t){function a(){var e=s.graphics,a=d.graphics;e.clear(),a.clear(),e.setStrokeStyle("2").beginStroke("#ded2b3"),a.setStrokeStyle("2").beginStroke("#ded2b3");var i=r.parent.localToLocal(n.x,n.y,s),o=r.parent.localToLocal(t.x,t.y,d);e.moveTo(0,0),a.moveTo(0,0),e.lineTo(i.x,i.y),a.lineTo(o.x,o.y),e.endStroke(),a.endStroke()}var r=new Sail(180,26,90);r.name="square";var i=20,o=new createjs.Shape,c=new createjs.Shape,s=new createjs.Shape,d=new createjs.Shape;return s.x=-(e/2)+10,d.x=e/2-10,s.y=d.y=-5,c.graphics.beginFill("#52352A"),c.graphics.drawRoundRect(-(e/2),-6,e,6,4),c.graphics.endFill(),r.addChild(s,d,o,c),r.drawSail=function(){var n=o.graphics;if(n.clear(),n.beginFill("#FFF"),r.power>0){var t=-(r.power*i);n.moveTo(-(e/2),-5),n.curveTo(-(.4*e),t/2,-(.4*e),t),n.curveTo(0,2*t,.4*e,t),n.curveTo(.4*e,t/2,e/2,-5),n.lineTo(-(e/2),-5)}n.endFill(),a()},r},ForeAft=function(e,n){function t(){var e=o.graphics;e.clear(),e.setStrokeStyle("2").beginStroke("#ded2b3");var t=a.parent.localToLocal(n.x,n.y,o);e.moveTo(0,0),e.lineTo(t.x,t.y),e.endStroke()}var a=new Sail(45,60,135);a.name="fore-aft";var r=new createjs.Shape,i=new createjs.Shape,o=new createjs.Shape;return o.y=e-10,i.graphics.beginFill("#52352A"),i.graphics.drawRoundRect(-3,0,6,e,4),i.graphics.endFill(),a.addChild(o,i,r),a.drawSail=function(){var n=r.graphics;n.clear(),n.beginFill("#FFF"),n.moveTo(0,0);var i="port"==a.tack?a.power:-a.power;n.curveTo(-30*i,.9*e,0,e),n.lineTo(0,0),n.endFill(),t()},a},Helm=function(e){var n=e||100,t=100,a={},r=!1,i=0;return a.turnLeft=function(){r=!0,i>-t&&(i-=n)},a.turnRight=function(){r=!0,t>i&&(i+=n)},a.stopTurning=function(){r=!1},a.__defineGetter__("turnAmount",function(){return i/t}),setInterval(function(){r||(i>0?i-=n:0>i&&(i+=n))},100),a},Game=function(){function e(e){console.log("handleFileLoad: ",e),c.push(e.item)}function n(){console.log("startGame"),o.assets={};for(var e=0;e<c.length;e++)console.log(c[e]),o.assets[c[e].id]=l.getResult(c[e].id);console.log("Game.assets",o.assets);var n=o.world=new World;d=new Viewport(n),u=new Gauge,d.width=s.canvas.width,d.height=s.canvas.height,u.x=s.canvas.width-75,u.y=s.canvas.height-75,s.addChild(d,u),createjs.Ticker.setFPS(60),createjs.Ticker.addEventListener("tick",i),t()}function t(){d&&(s.canvas.width=window.innerWidth,s.canvas.height=window.innerHeight,d.canvasSizeChanged(s.canvas.width,s.canvas.height),u.x=s.canvas.width-75,u.y=s.canvas.height-75)}function a(e){switch(e.keyCode){case 38:break;case 40:break;default:o.dispatchEvent({type:"onKeyDown",key:e.keyCode})}}function r(e){switch(e.keyCode){case 187:d.zoomIn();break;case 189:d.zoomOut();break;case 27:o.dispatchEvent("escape");break;default:o.dispatchEvent({type:"onKeyUp",key:e.keyCode})}}function i(){u.update(),s.update(),document.getElementById("fps").innerHTML=Math.round(createjs.Ticker.getMeasuredFPS())+" fps"}var o={},c=[];createjs.EventDispatcher.initialize(o);var s,d,u,l;return o.init=function(t){s=new createjs.Stage(document.getElementById(t)),createjs.Touch.enable(s),s.enableMouseOver(10),s.mouseMoveOutside=!1,s.snapToPixelEnabled=!0,manifest=[{src:"images/tide_repeat.png",id:"waves"}],l=new createjs.LoadQueue(!1),l.onFileLoad=e,l.onComplete=n,l.loadManifest(manifest)},o.escape=function(){},$(document).ready(function(){console.log("DOCUMENT READY"),window.onresize=t,window.onkeydown=a,window.onkeyup=r}),o}();