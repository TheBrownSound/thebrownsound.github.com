var Utils=function(){var e={};return e.convertToHeading=function(e){var t=e%360;return 0>t?t+360:t},e.convertToNumber=function(e){return e>180?e-360:e},e.getAxisSpeed=function(e,t){return{x:Math.sin(e*Math.PI/180)*t,y:Math.cos(e*Math.PI/180)*t}},e.headingDifference=function(e,t){var n=(t-e)%360;return n>180&&(n-=360),n},e.oldHeadingDifference=function(e,t){var n=Math.abs(t-e)%360;return n>180&&(n=360-n),n},e.getRelativeHeading=function(e,t){var n=t.x-e.x,a=e.y-t.y,i=Math.round(Math.atan2(n,a)*(180/Math.PI));return this.convertToHeading(i)},e.distanceBetweenTwoPoints=function(e,t){var n=t.x-e.x;n*=n;var a=t.y-e.y;return a*=a,Math.sqrt(n+a)},e.getRandomInt=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},e.getRandomFloat=function(e,t){return Math.random()*(t-e)+e},e.yesNo=function(){return 1==this.getRandomInt(0,1)?!0:!1},e.getDebugMarker=function(){var e=new createjs.Shape;return e.graphics.beginFill("#F00"),e.graphics.drawCircle(0,0,10),e.graphics.endFill(),e},e.removeFromArray=function(e,t){var n=e.indexOf(t);return n>=0?(e.splice(t,1),!0):!1},e}(),Particles=function(){var e={};return e.Smoke=function(e){function t(){n.parent.removeChild(n)}e=e||360;var n=new createjs.Container,a=new createjs.Bitmap("images/smoke.png");return a.regX=a.regY=25,n.addChild(a),n.animate=function(i){i=i||{x:0,y:0};var r=Utils.getRandomInt(0,e),o=Utils.getRandomFloat(.2,1),s=Utils.getRandomInt(-360,360),c=Utils.getAxisSpeed(r+this.rotation,Utils.getRandomInt(50,100));n.scaleX=n.scaleY=o;var l=3e3;createjs.Tween.get(this,{loop:!1}).to({x:n.x+c.x+30*i.x,y:n.y-c.y-30*i.y},l,createjs.Ease.circOut),createjs.Tween.get(this,{loop:!1}).to({scaleX:0,scaleY:0},l,createjs.Ease.expoIn).call(t),createjs.Tween.get(a,{loop:!1}).to({rotation:s},l,createjs.Ease.circOut)},n},e.Splinter=function(e){function t(){n.parent.removeChild(n)}e=e||360;var n=new createjs.Container,a=Utils.getRandomInt(1,3),i=new createjs.Bitmap("images/splinter"+Utils.getRandomInt(1,3)+".png");return i.regX=15*a/2,i.regY=5,n.addChild(i),n.animate=function(){var a=Utils.getRandomInt(0,e),r=Utils.getRandomFloat(.2,1),o=Utils.getRandomInt(-720,720),s=Utils.getAxisSpeed(a+this.rotation,Utils.getRandomInt(0,100));n.scaleX=n.scaleY=r,createjs.Tween.get(n,{loop:!1}).to({x:n.x+s.x,y:n.y-s.y},1500,createjs.Ease.quintOut).to({scaleX:.1,scaleY:.1,alpha:0},2e3,createjs.Ease.quadIn).call(t),createjs.Tween.get(i,{loop:!1}).to({rotation:o},2e3,createjs.Ease.quintOut)},n},e.Bubble=function(){function e(){n.parent.removeChild(n)}var t=100,n=new createjs.Shape;return n.graphics.beginFill("#95cbdc"),n.graphics.drawCircle(-5,-5,10),n.graphics.endFill(),n.scaleX=n.scaleY=.1,n.animate=function(){var a=Utils.getRandomFloat(-t,t)+n.x,i=Utils.getRandomFloat(-t,t)+n.y,r=Utils.getRandomFloat(1,3);createjs.Tween.get(n,{loop:!1}).set({scaleX:.1,scaleY:.1},n).to({x:a,y:i,scaleX:r,scaleY:r,alpha:0},3e3,createjs.Ease.easeOut).call(e)},n},e}(),Viewport=function(e){function t(t){i+=t;var n=Math.abs(i%r.length);createjs.Tween.get(e,{override:!0}).to({scaleX:r[n],scaleY:r[n]},1e3,createjs.Ease.sineOut)}var n=400,a=300,i=1,r=[.25,.5,1],o=new createjs.Container;o.name="viewport";var s=new Gauge;return e.x=n/2,e.y=a/2,o.addChild(e,s),o.__defineGetter__("width",function(){return n}),o.__defineSetter__("width",function(e){return o.canvasSizeChanged(e,a),n}),o.__defineGetter__("height",function(){return a}),o.__defineSetter__("height",function(e){return o.canvasSizeChanged(n,e),a}),o.canvasSizeChanged=function(t,i){console.log("canvasSizeChanged",t,i),n=t,a=i,s.x=t-75,s.y=75,e.x=t/2,e.y=i/2},o.zoomIn=function(){t(1)},o.zoomOut=function(){t(-1)},o},World=function(){function e(e){i.ships.length<5&&(console.log("adding boat",e),e.addEventListener("sunk",function(){var t=i.ships.indexOf(e);t>=0&&i.ships.splice(t,1)}),r.addChild(e),i.ships.push(e))}function t(){var t=new Pirate,n=1e3,a=Utils.getRandomInt(n,3e3),i=Utils.getRandomInt(0,1)?-a:a,r=Utils.getRandomInt(n,3e3),o=Utils.getRandomInt(0,1)?-r:r;t.x=i+s.x,t.y=o+s.y,s.health>0&&t.attack(s),e(t)}function n(){var e=10===Utils.getRandomInt(0,10);console.log("Spawn event: ",e),e&&t()}function a(){document.getElementById("heading").innerHTML="Heading: "+Math.round(s.heading),document.getElementById("knots").innerHTML="Knots: "+Math.round(s.knots),r.regX=s.x,r.regY=s.y,o.position.x=-s.x,o.position.y=-s.y,o.update();var e=Math.sin(s.heading*Math.PI/180)*-s.speed,t=Math.cos(s.heading*Math.PI/180)*s.speed;createjs.Tween.get(r,{override:!0}).to({x:100*e,y:100*t},1e3,createjs.Ease.sineOut),createjs.Tween.get(o,{override:!0}).to({x:100*e,y:100*t},1e3,createjs.Ease.sineOut)}var i=new createjs.Container;i.name="world",i.ships=[];var r=i.map=new createjs.Container,o=i.ocean=new Ocean(500,500);i.weather=new Weather;var s=i.playerBoat=new PlayerBoat,c=new createjs.Bitmap("images/island.png");c.y=-2e3;var l=new createjs.Shape;return l.graphics.beginFill("#F00"),l.graphics.drawCircle(-5,-5,20),l.graphics.endFill(),r.addChild(l,c),i.addChild(o,r),e(s),setInterval(function(){n()},1e4),Game.stage.onMouseDown=function(e){var t=Game.world.playerBoat.globalToLocal(e.stageX,e.stageY);console.log(t)},i.addPirate=t,createjs.Ticker.addEventListener("tick",a),i},Gauge=function(){function e(){n.rotation=Game.world.weather.wind.direction,i.rotation=Game.world.playerBoat.heading}var t=new createjs.Container;t.width=t.height=100;var n=new createjs.Bitmap("images/windgauge.png"),a=new createjs.Bitmap("images/compass.png"),i=new createjs.Bitmap("images/needle.png");return n.regX=a.regX=i.regX=t.width/2,n.regY=a.regY=i.regY=t.height/2,t.addChild(n,a,i),createjs.Ticker.addEventListener("tick",e),t},Ocean=function(e,t){function n(){r.x=a.position.x%200,r.y=a.position.y%150}var a=new createjs.Container;a.width=e,a.height=t,a.position={x:0,y:0};var i=3*e+3*t,r=new createjs.Shape,o=r.graphics;o.beginBitmapFill(Game.assets.waves),o.drawRect(-i,-i,2*i,2*i);var s=new createjs.Container;return a.addChild(s,r),a.spawnBubble=function(){var e=new Particles.Bubble;e.x=-a.position.x,e.y=-a.position.y,e.animate(),s.addChild(e)},a.update=function(){document.getElementById("coords").innerHTML="x:"+a.position.x+" - y:"+a.position.y,s.x=a.position.x,s.y=a.position.y,n()},a},Weather=function(){var e={wind:{speed:10,direction:45}};return e},Boat=function(){function e(){for(var e=0,t=0,n=0;n<u.sails.length;n++){var a=u.sails[n];e+=a.speed,t+=a.power}if(c>0){var i=1/Math.sqrt(u.sails.length);t=t/u.sails.length*e*i,t=Math.round(1e3*t)/1e3}o!=t&&(o>t&&(o-=.005),t>o&&(o+=.01))}function t(){var e=Utils.convertToHeading(Game.world.weather.wind.direction-u.rotation);u.sails.map(function(t){t.trim(e)})}function n(){console.log("sunk");for(var e=0;40>e;e++){var t=new Particles.Smoke;t.x=u.x,t.y=u.y,u.parent.addChildAt(t,1),t.animate()}for(var e=0;20>e;e++){var n=new Particles.Splinter;n.x=u.x,n.y=u.y,u.parent.addChildAt(n,1),n.animate()}createjs.Ticker.removeEventListener("tick",a),u.parent.removeChild(u),u.dispatchEvent("sunk")}function a(){e();var n=g.turnAmount,a=d-Game.world.weather.wind.direction;if(0!==n||0!==a){if(d=Game.world.weather.wind.direction,0!==n){var i=(u.rotation+n)%360;u.rotation=0>i?i+360:i}!s&&c>0&&t()}if(l+=Math.round(u.speed),l>=7){l=0;var r=new Particles.Bubble,o=u.localToLocal(0,0,u.parent);r.x=o.x,r.y=o.y,r.animate(),u.parent.addChildAt(r,0)}var h=Math.sin(u.heading*Math.PI/180)*u.speed,f=Math.cos(u.heading*Math.PI/180)*u.speed;u.x+=h,u.y-=f,u.dispatchEvent("moved")}var i=56,r=125,o=0,s=!0,c=100,l=0,d=0,u=new createjs.Container;u.regY=r/2,createjs.EventDispatcher.initialize(u);var h=new createjs.Bitmap("images/small_boat.png"),g=new Helm(u);return h.x=-(i/2),u.sails=[],u.guns=[],u.addChild(h),u.turnLeft=g.turnLeft,u.turnRight=g.turnRight,u.setSailColor=function(e){for(var t in this.sails)this.sails[t].color=e},u.addSail=function(e){this.sails.push(e),this.addChild(e)},u.addGun=function(e){this.guns.push(e),this.addChildAt(e,1)},u.stopTurning=function(){g.stopTurning(),u.rotation=Math.round(u.rotation)},u.furlSails=function(){u.sails.map(function(e){e.reef()})},u.hoistSails=function(){u.sails.map(function(e){e.hoist()}),t()},u.toggleSails=function(){s?this.hoistSails():this.furlSails(),s=!s},u.cannonHit=function(e,t){var n=Math.round(e);u.damage(n);for(var a=0;n>a;a++){var i=new Particles.Splinter,r=u.localToLocal(t.x,t.y,u.parent);i.x=r.x,i.y=r.y,u.parent.addChildAt(i,1),i.animate()}},u.damage=function(e){c>0&&(console.log(c),c-=e,0>=c&&(c=0,n()))},u.__defineGetter__("speed",function(){return o}),u.__defineGetter__("knots",function(){var e=4;return Math.round(o*e)}),u.__defineGetter__("heading",function(){var e=u.rotation%360;return 0>e?e+360:e}),u.__defineGetter__("width",function(){return i}),u.__defineGetter__("length",function(){return r}),u.getSternPosition=function(){return r-u.regY},createjs.Ticker.addEventListener("tick",a),u},PlayerBoat=function(){function e(){if(n)for(var e in t.guns){var a=t.guns[e];for(var i in Game.world.ships){var r=Game.world.ships[i];r!=t&&a.isInRange(r)&&a.shoot()}}}var t=new Boat;t.name="PlayerBoat",t.setSailColor("#FFF");var n=!1,a=56,i=125,r=new SquareRig(1.5*a,{x:-23,y:.6*i},{x:23,y:.6*i}),o=new ForeAft(.5*i,{x:0,y:.7*i});r.y=35,o.y=40,t.addSail(r),t.addSail(o);var s=new Gun(6,18,t),c=new Gun(6,18,t);return s.y=c.y=58,s.x=-14,c.x=14,s.rotation=-90,c.rotation=90,t.addGun(s),t.addGun(c),setInterval(e,100),Game.addEventListener("onKeyDown",function(e){switch(e.key){case 37:t.turnLeft();break;case 39:t.turnRight();break;case 32:t.toggleFireMode()}}),Game.addEventListener("onKeyUp",function(e){switch(e.key){case 83:t.toggleSails();break;case 37:case 39:t.stopTurning()}}),t.toggleFireMode=function(){return n=!n,document.getElementById("fireMode").innerHTML=n?"Hold Fire":"Fire At Will",n},t},AIBoat=function(){function e(){if("combat"===d&&h){var e=r(h);n(e)}else"wander"===d&&i()}function t(){if("combat"===d&&h)for(var e in l.guns){var t=l.guns[e];t.isInRange(h)&&t.shoot()}}function n(e){switch(typeof e){case"number":a(e);break;case"object":var t=Utils.getRelativeHeading(l,e);a(t)}l.hoistSails()}function a(e){var t=(e-l.heading)%360;t>180&&(t-=360);var n=50*Math.abs(t);createjs.Tween.get(l,{override:!0}).to({rotation:l.rotation+t},n,createjs.Ease.sineOut)}function i(){if(h)h--,0>=h&&(h=!1);else{var e=Utils.getRandomInt(30,120)/2;h=e;var t=Utils.getRandomInt(1,360);n(t)}}function r(e){var t=120,n={left:e.localToLocal(-t,0,l.parent),right:e.localToLocal(t,0,l.parent)},a=Utils.distanceBetweenTwoPoints(n.left,{x:l.x,y:l.y}),i=Utils.distanceBetweenTwoPoints(n.right,{x:l.x,y:l.y});return i>a?n.left:n.right}function o(){clearInterval(g),clearInterval(f)}function s(e){d="combat",h=e}function c(e){var t=e.target;Utils.removeFromArray(u,t),t.removeEventListener("sunk",c),t===h&&(u.length>0?s(u[0]):(h=!1,d="wander"))}var l=new Boat,d="wander",u=[],h=!1,g=setInterval(e,2e3),f=setInterval(t,100);return l.attack=function(e){u.push(e),e.addEventListener("sunk",c),h||s(e)},l.evade=function(){d="evade"},l.addEventListener("sunk",function(){o()}),l},Pirate=function(){var e=new AIBoat,t=125,n=new ForeAft(.5*t,{x:0,y:t-10}),a=new Gun(8,32,e),i=new Gun(8,32,e);return n.y=55,a.y=i.y=100,a.x=-10,i.x=10,a.rotation=-90,i.rotation=90,e.addSail(n),e.setSailColor("#444"),e.addGun(a),e.addGun(i),e},Sail=function(e,t,n){function a(){if(s)o=Math.round(10*o)/10,o>0?o-=.1:0>o&&(o+=.1);else{var e=10,t=Utils.convertToHeading(l.angle),a=Utils.oldHeadingDifference(c,t);if(a>n+e)o=0;else{var i=Math.abs(r-a),d=(n-i)/n;o=Math.round(100*d)/100}}l.drawSail&&l.drawSail()}function i(e){createjs.Tween.get(l,{override:!0}).to({rotation:e},2e3,createjs.Ease.linear)}var r=180-e,o=0,s=!0,c=0,l=new createjs.Container;return l.speed=2.2,l.sailColor="#ded5be",l.lineColor="#2a2824",l.hoist=function(){s=!1},l.reef=function(){s=!0,i(0)},l.trim=function(e){if(!s){c=e;var t=Math.abs(Utils.convertToNumber(e))>n;if(t)l.angle=0;else{var a=e>180?r:-r;l.angle=Utils.convertToNumber(e+a)}}},l.__defineSetter__("angle",function(e){if(!s){var n=e;-t>e?n=-t:e>t&&(n=t),i(n)}}),l.__defineGetter__("angle",function(){return l.rotation}),l.__defineGetter__("power",function(){return o}),l.__defineGetter__("reefed",function(){return s}),l.__defineGetter__("tack",function(){return c>180?"port":"starboard"}),l.__defineSetter__("color",function(e){l.sailColor=e}),createjs.Ticker.addEventListener("tick",a),l},SquareRig=function(e,t,n){function a(){var e=h.graphics,a=g.graphics;e.clear(),a.clear(),e.setStrokeStyle("2").beginStroke(i.lineColor),a.setStrokeStyle("2").beginStroke(i.lineColor);var r=i.parent.localToLocal(t.x,t.y,h),o=i.parent.localToLocal(n.x,n.y,g);e.moveTo(0,0),a.moveTo(0,0),e.lineTo(r.x,r.y),a.lineTo(o.x,o.y),e.endStroke(),a.endStroke()}var i=new Sail(180,26,90);i.name="square",i.speed=2.5;var r=20,o=6,s=5,c=e/s,l=new createjs.Shape,d=new createjs.Shape,u=new createjs.Shape,h=new createjs.Shape,g=new createjs.Shape;h.x=-(e/2)+10,g.x=e/2-10,h.y=g.y=0,d.graphics.beginFill("#52352A"),d.graphics.drawRoundRect(-(e/2),-3,e,o,o/2),d.graphics.endFill(),u.graphics.beginFill(i.lineColor);for(var f=0;s-1>f;f++)u.graphics.drawRoundRect(-e/2+c+c*f,-(o+2)/2,2,o+2,2);return u.graphics.endFill(),i.addChild(h,g,l,d,u),i.drawSail=function(){var t=l.graphics;if(t.clear(),this.reefed&&0==this.power){t.beginFill(this.sailColor);for(var n=0;s>n;n++)t.drawEllipse(-e/2+c*n,-c/4,c,c/2);t.endFill()}else{var o=-(i.power*r);t.beginFill(this.sailColor),t.moveTo(-(e/2),-2),t.curveTo(-(.4*e),o/2,-(.4*e),o),t.curveTo(0,2*o,.4*e,o),t.curveTo(.4*e,o/2,e/2,-2),t.curveTo(0,o,-(e/2),-2),t.endFill()}a()},i},ForeAft=function(e,t){function n(){var e=o.graphics;e.clear(),e.setStrokeStyle("2").beginStroke(a.lineColor);var n=a.parent.localToLocal(t.x,t.y,o);e.moveTo(0,0),e.lineTo(n.x,n.y),e.endStroke()}var a=new Sail(45,45,135);a.name="fore-aft";var i=new createjs.Shape,r=new createjs.Shape,o=new createjs.Shape;return o.y=e-10,r.graphics.beginFill("#52352A"),r.graphics.drawRoundRect(-3,0,6,e,4),r.graphics.endFill(),a.addChild(o,r,i),a.drawSail=function(){var t=i.graphics;if(t.clear(),this.reefed&&0==this.power){var r=4,o=e/r;t.beginFill(this.sailColor);for(var s=0;r>s;s++)t.drawEllipse(-o/4,o*s,o/2,o);t.endFill(),t.beginFill(this.lineColor);for(var s=0;r-1>s;s++)t.drawRoundRect(-o/8,o*s+o-2,o/4,2,2);t.endFill()}else{var c="port"==a.tack?this.power:-this.power;t.beginFill(this.sailColor),t.moveTo(0,0),t.curveTo(-40*c,.7*e,0,e),t.curveTo(-10*c,e/2,0,0),t.endFill()}n()},a},Helm=function(e){function t(){var t=Math.round(20*e.knots);return n>t&&t>a?t:t>=n?n:a}var n=100,a=20,i={},r=null;return i.turnLeft=function(){r="left"},i.turnRight=function(){r="right"},i.stopTurning=function(){r=null},i.__defineGetter__("turnAmount",function(){switch(r){case"left":return-t()/n;case"right":return t()/n;default:return 0}}),i},Gun=function(e,t,n){function a(){var e=s.graphics;e.beginFill("#000"),e.moveTo(0,0),e.curveTo(d/2,0,d/2,-(d/2)),e.lineTo(d/2-d/4,-t),e.lineTo(-(d/2)+d/4,-t),e.lineTo(-(d/2),-(d/2)),e.curveTo(-(d/2),0,0,0),e.endFill(),e.beginFill("#000"),e.drawRoundRect(-(d/2),-t,d,d/2,d/4),e.endFill(),e.beginFill("#000"),e.drawCircle(0,0,d/4),e.endFill()}function i(){s.y+=e,createjs.Tween.get(s,{override:!0}).wait(c-1e3).to({y:0},1e3,createjs.Ease.sineOut)}function r(){var a=Utils.convertToHeading(n.rotation+o.rotation),r=new Projectile(.75*e,a,n),s=o.localToLocal(0,-t,n.parent);r.x=s.x,r.y=s.y,n.parent.addChildAt(r,2);for(var d=0;e>d;d++){var u=new Particles.Smoke(60);u.x=s.x,u.y=s.y,u.rotation=n.rotation+o.rotation-30;var h=Utils.getAxisSpeed(n.heading,n.speed);u.animate(h),n.parent.addChild(u)}i(),l=!1,setTimeout(function(){l=!0},c)}var o=new createjs.Container,s=new createjs.Shape;o.addChild(s);var c=1e3*e+100*t,l=!0,d=e,t=t||3*e;return o.shoot=function(){l&&r()},o.isInRange=function(e){var t=Utils.convertToHeading(n.heading+this.rotation),a=Utils.getRelativeHeading(o.localToLocal(0,0,n.parent),e),i=20,r=Utils.headingDifference(t,a);return Math.abs(r)<=i},a(),o},Projectile=function(e,t,n){function a(){createjs.Ticker.removeEventListener("tick",o),u.parent.removeChild(u)}function i(){for(var e in Game.world.ships){var t=Game.world.ships[e];if(t!=n){var i=u.localToGlobal(0,0),r=t.globalToLocal(i.x,i.y),o=t.hitTest(r.x,r.y);if(o)return t.cannonHit(s,r),a(),void 0}}}function r(){for(var e=0;30>e;e++){var t=new Particles.Bubble;t.x=u.x,t.y=u.y,u.parent.addChild(t),t.animate()}a()}function o(){c--,c>0?(u.x+=Math.sin(t*Math.PI/180)*s+l,u.y-=Math.cos(t*Math.PI/180)*s-d,i()):r()}var s=2*e,c=4*s,l=Math.sin(n.heading*Math.PI/180)*n.speed,d=Math.cos(n.heading*Math.PI/180)*-n.speed,u=new createjs.Shape;return u.graphics.beginFill("#000"),u.graphics.drawCircle(0,0,e/2),u.graphics.endFill(),createjs.Ticker.addEventListener("tick",o),u},Game=function(){function e(e){console.log("handleFileLoad: ",e),s.push(e.item)}function t(){console.log("startGame"),o.assets={};for(var e=0;e<s.length;e++)console.log(s[e]),o.assets[s[e].id]=d.getResult(s[e].id);console.log("Game.assets",o.assets);var t=o.world=new World;l=new Viewport(t),l.width=c.canvas.width,l.height=c.canvas.height,c.addChild(l),createjs.Ticker.setFPS(60),createjs.Ticker.addEventListener("tick",r),n()}function n(){l&&(c.canvas.width=window.innerWidth,c.canvas.height=window.innerHeight,l.canvasSizeChanged(c.canvas.width,c.canvas.height))}function a(e){switch(e.keyCode){case 38:break;case 40:break;default:o.dispatchEvent({type:"onKeyDown",key:e.keyCode})}}function i(e){switch(e.keyCode){case 187:l.zoomIn();break;case 189:l.zoomOut();break;case 27:o.dispatchEvent("escape");break;default:o.dispatchEvent({type:"onKeyUp",key:e.keyCode})}}function r(){c.update(),document.getElementById("fps").innerHTML=Math.round(createjs.Ticker.getMeasuredFPS())+" fps"}var o={},s=[];createjs.EventDispatcher.initialize(o);var c,l,d;return o.init=function(n){c=o.stage=new createjs.Stage(document.getElementById(n)),createjs.Touch.enable(c),c.enableMouseOver(10),c.mouseMoveOutside=!1,c.snapToPixelEnabled=!0,manifest=[{src:"images/tide_repeat.png",id:"waves"}],d=new createjs.LoadQueue(!1),d.onFileLoad=e,d.onComplete=t,d.loadManifest(manifest)},o.escape=function(){},$(document).ready(function(){console.log("DOCUMENT READY"),window.onresize=n,window.onkeydown=a,window.onkeyup=i}),o}();